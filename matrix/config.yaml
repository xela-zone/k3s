apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-config
  namespace: matrix
data:
  homeserver.yaml: |
    server_name: "matrix.kbrt.xyz"
    public_baseurl: "https://matrix.kbrt.xyz"
    
    # --- Ports ---
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        resources:
          - names: [client, federation]
            compress: false

    # --- Database ---
    database:
      name: psycopg2
      args:
        user: synapse
        password: "DB_PASSWORD_PLACEHOLDER"
        database: synapse
        host: matrix-db-rw.matrix.svc
        cp_min: 5
        cp_max: 10

    # --- Security & Auth (MAS Integration) ---
    enable_registration: false
    enable_registration_without_verification: false
    
    registration_shared_secret: "REGISTRATION_SECRET_PLACEHOLDER"
    macaroon_secret_key: "MACAROON_SECRET_PLACEHOLDER"
    
    signing_key_path: "/secrets/signing.key"

    # Disable Password Login (Managed by MAS)
    password_config:
      enabled: false

    # Enable MSC3861 (Delegated Auth)
    experimental_features:
      msc3861:
        enabled: true
        issuer: http://mas.matrix.svc:8080/
        client_id: 01HCGY0Z10896D686D746D746D
        client_auth_method: client_secret_post
        client_secret: "MACAROON_SECRET_PLACEHOLDER" # Reusing as shared secret

    # --- Media (S3) ---
    media_store_path: /data/media_store
    max_upload_size: 100M
    
    media_storage_providers:
      - module: s3_storage_provider.S3StorageProviderBackend
        store_local: true
        store_synchronous: true
        store_remote: true
        config:
          bucket: "assets-6a939b"
          region_name: "us-west-004"
          endpoint_url: "https://s3.us-west-004.backblazeb2.com"
          access_key_id: "ACCESS_KEY_PLACEHOLDER"
          secret_access_key: "SECRET_KEY_PLACEHOLDER"
          prefix: "media/"
          public_baseurl: "https://assets.kbrt.xyz/"

    # --- Metrics ---
    enable_metrics: true
    report_stats: false